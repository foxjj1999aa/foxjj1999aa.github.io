<!DOCTYPE html>
<html>

<head>
	<table border="1" width="30%" Height="8%">
		<tr>
			<th width="10%"> <a href="https://foxjj1999aa.github.io/抽獎公佈欄.HTML">抽獎公佈欄</a></th>

			<th width="10%"> <a href="https://foxjj1999aa.github.io/SearchPoint.HTML">點數查詢</a></th>

			<th width="10%"> <a href="https://foxjj1999aa.github.io/抽獎前置.HTML">輸入點數</a></th>

		</tr>
	</table>

	<link rel="stylesheet" type="text/css" href="https://foxjj1999aa.github.io/styleCJ.css" />

</head>

<body>

	<p align=center><img src="https://foxjj1999aa.github.io/超級百logo.png" width="80%"></p>

	<div class="shanDeng" id="deng">
		<div id="luck">
			<!-- luck -->
			<table>
				<tr>
					<td class="luck-unit luck-unit-0"><img src="https://foxjj1999aa.github.io/Tea.png"></td>
					<td class="luck-unit luck-unit-1"><img src="https://foxjj1999aa.github.io/Tea.png"></td>
					<td class="luck-unit luck-unit-2"><img src="https://foxjj1999aa.github.io/Tea.png"></td>
					<td class="luck-unit luck-unit-3"><img src="https://foxjj1999aa.github.io/Tea.png"></td>
				</tr>
				<tr>
					<td class="luck-unit luck-unit-11"><img src="https://foxjj1999aa.github.io/Tea.png"></td>
					<td rowspan="2" colspan="2" class="cjBtn" id="btn"></td>
					<td class="luck-unit luck-unit-4"><img src="https://foxjj1999aa.github.io/Tea.png"></td>
				</tr>
				<tr>
					<td class="luck-unit luck-unit-10"><img src="https://foxjj1999aa.github.io/Tea.png"></td>
					<td class="luck-unit luck-unit-5"><img src="https://foxjj1999aa.github.io/Tea.png"></td>
				</tr>
				<tr>
					<td class="luck-unit luck-unit-9"><img src="https://foxjj1999aa.github.io/Tea.png"></td>
					<td class="luck-unit luck-unit-8"><img src="https://foxjj1999aa.github.io/Tea.png"></td>
					<td class="luck-unit luck-unit-7"><img src="https://foxjj1999aa.github.io/Tea.png"></td>
					<td class="luck-unit luck-unit-6"><img src="https://foxjj1999aa.github.io/Tea.png"></td>
				</tr>
			</table>
		</div><!-- luckEnd -->
	</div>
	<script src="https://www.gstatic.com/firebasejs/5.9.1/firebase.js"></script>
	<script>
		var Username = location.search.substr(1);
		var config = {
			apiKey: "AIzaSyA2zAXlG4Q2Pq_x3RUe7J_JrwdiVhBjtqI",
			authDomain: "webtest-49dac.firebaseapp.com",
			databaseURL: "https://webtest-49dac.firebaseio.com",
			projectId: "webtest-49dac",
			storageBucket: "webtest-49dac.appspot.com",
			messagingSenderId: "520140906035"
		};
		firebase.initializeApp(config);
		var db = firebase.database();

	</script>
	<script src="jquery-1.8.3.min.js"></script>
	<script>
		var Username = location.search.substr(1);
		var Price;
		var ID=[];
		var Nnumber=[];
		var UserCount;
		var getIndex;
		var luck = {
			index: -1,	//当前转动到哪个位置，起点位置
			count: 0,	//总共有多少个位置
			timer: 0,	//setTimeout的ID，用clearTimeout清除
			speed: 20,	//初始转动速度
			times: 0,	//转动次数
			cycle: 50,	//转动基本次数：即至少需要转动多少次再进入抽奖环节
			prize: -1,	//中奖位置
			init: function (id) {
				if ($("#" + id).find(".luck-unit").length > 0) {
					$luck = $("#" + id);
					$units = $luck.find(".luck-unit");
					this.obj = $luck;
					this.count = $units.length;
					$luck.find(".luck-unit-" + this.index).addClass("active");

				};
			},


			roll: function () {
				var index = this.index;
				var count = this.count;
				var luck = this.obj;
				$(luck).find(".luck-unit-" + index).removeClass("active");
				index += 1;
				if (index > count - 1) {
					index = 0;
				};
				$(luck).find(".luck-unit-" + index).addClass("active");
				this.index = index;
				return false;

			},
			stop: function (index) {
				this.prize = index;
				return false;
			}
		};


		function roll() {
			luck.times += 1;
			luck.roll();
			if (luck.times > luck.cycle + 10 && luck.prize == luck.index) {
				clearTimeout(luck.timer);
				luck.prize = -1;
				luck.times = 0;
				click = false;


			} else {
				if (luck.times < luck.cycle) {
					luck.speed -= 10;
				} else if (luck.times == luck.cycle) {
					var index = Math.random() * (luck.count) | 0;
					luck.prize = index;
					getIndex = index;
					UpdateGift();
					Price = index;
				} else {
					if (luck.times > luck.cycle + 10 && ((luck.prize == 0 && luck.index == 7) || luck.prize == luck.index + 1)) {
						luck.speed += 110;
					} else {
						luck.speed += 20;
					}
				}
				if (luck.speed < 40) {
					luck.speed = 40;

				};


				luck.timer = setTimeout(roll, luck.speed);
			}
			return false;
		}
		function UpdateGift() {

			db.ref("Gift").once("value").then(function (snapshot) {
				UserCount = snapshot.numChildren();
				if (UserCount < 20) {
					setTimeout(UpdateGift2, 1000);
				} else {
					setTimeout(change, 1000);
				}
			});

		}
		function change() {
			for (let i = 0; i < UserCount; i++) {
				db.ref("Gift/" + i + "/ID").once("value").then(function (snapshot) {
					ID.push(snapshot.val());
				});
				db.ref("Gift/" + i + "/Number").once("value").then(function (snapshot) {
					Nnumber.push(snapshot.val());
				});
			}
			setTimeout(change1, 1000);

		}
		function change1() {
			for (let i = 0; i < UserCount - 1; i++) {
				db.ref("Gift/" + i + "/ID").set(ID[i + 1]);
			}
			for (let i = 0; i < UserCount - 1; i++) {
				db.ref("Gift/" + i + "/Number").set(Nnumber[i + 1]);
			}
			setTimeout(change2, 1000);
		}
		function change2() {
			db.ref("Gift/19/ID").set(Username);
			db.ref("Gift/19/Number").set(getIndex);
			setTimeout(UpdateGift3, 2500);
		}
		function UpdateGift2() {

			db.ref("Gift/" + UserCount + "/ID").set(Username);
			db.ref("Gift/" + UserCount + "/Number").set(getIndex);
			setTimeout(UpdateGift3, 2500);
		}
		function UpdateGift3() {
			alert("恭喜你抽中" + getIndex + "號獎");
			document.location.href = "https://foxjj1999aa.github.io/抽獎公佈欄.HTML?" + Username;
		}
		//闪灯效果
		var num = 0;
		$(".shanDeng").attr("class", function () {
			setInterval(function () {
				num++;
				if (num % 2 == 0) {
					$('#deng').addClass("shanDeng2");
				} else {
					$('#deng').addClass("shanDeng");
					$('#deng').removeClass('shanDeng2');
				}
			}, 500)
		})


		var click = false;
		window.onload = function () {
			luck.init('luck');
			$("#btn").click(function () {
				//按下弹起效果
				$("#btn").addClass("cjBtnDom");
				setTimeout(function () {
					$("#btn").removeClass("cjBtnDom");
				}, 200);


				if (click) {
					return false;
				}
				else {
					luck.speed = 100;
					roll();
					click = true;
					return false;

				}

			});
		};
	</script>


</body>

</html>